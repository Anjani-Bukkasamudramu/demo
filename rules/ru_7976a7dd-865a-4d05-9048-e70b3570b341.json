{
  "name": "projects/1017425675889/locations/europe-west3/instances/a099fd02-80fc-4a0f-a80c-fb5d7fe78564/rules/ru_7976a7dd-865a-4d05-9048-e70b3570b341",
  "revisionId": "v_1742252618_068943000",
  "displayName": "demoverse_user_download_executable_from_macro",
  "text": "rule demoverse_user_download_executable_from_macro {\n  \n  meta:\n    author = \"Google Cloud Security\"\n    description = \"Executable downloaded by Microsoft Excel by user with GCP entity relationship\"\n    type = \"alert\"\n    data_source = \"zscaler nss, crowdstrike\"\n    tags = \"user entity, resource entity\"\n    severity = \"High\"\n    priority = \"High\"\n    platform = \"Windows\"\n    assumption = \"This rule assumes that GCP DLP has been deployed and resources have been assigned to a user context\"\n    mitre_attack_tactic = \"Execution\"\n    mitre_attack_technique = \"User Execution: Malicious File\"\n    mitre_attack_url = \"https://attack.mitre.org/techniques/T1204/002/\"\n    mitre_attack_version = \"v13.1\"\n\n  events:\n    // proxy event with suspected executable download\n    $proxy_event.metadata.event_type = \"NETWORK_HTTP\"\n    $proxy_event.target.url =  /.*\\.exe$/ or\n    $proxy_event.network.received_bytes > 102400\n    $proxy_event.principal.user.userid = $user\n    $proxy_event.principal.user.userid != /test/\n\n    // correlate with EDR event indicating Excel activity\n    $edr_event.target.user.userid  = $user\n    $edr_event.principal.process.file.names = /excel/ nocase\n    $edr_event.metadata.event_type = \"PROCESS_LAUNCH\"    \n\n\n  match:\n    $user over 5m\n  \n  outcome:\n    $mitre_attack_tactic = \"Execution\"\n    $mitre_attack_technique = \"User Execution: Malicious File\"\n    $mitre_attack_technique_id = \"T1204.002\"\n    // added to populate alert graph with additional context\n    $principal_hostname = array_distinct($proxy_event.principal.hostname)\n    // Commented out target.hostname because it is already represented in graph as match variable. If match changes, can uncomment to add to results\n    $principal_process_pid = array_distinct($edr_event.principal.process.pid)\n    $principal_process_command_line = array_distinct($edr_event.principal.process.command_line)\n    $principal_process_file_sha256 = array_distinct($edr_event.principal.process.file.sha256)\n    $principal_process_file_full_path = array_distinct($edr_event.principal.process.file.full_path)\n    $principal_process_product_specfic_process_id = array_distinct($edr_event.principal.process.product_specific_process_id)\n    $principal_process_parent_process_product_specfic_process_id = array_distinct($edr_event.principal.process.parent_process.product_specific_process_id)\n    $target_process_pid = array_distinct($edr_event.target.process.pid)\n    $target_process_command_line = array_distinct($edr_event.target.process.command_line)\n    $target_process_file_sha256 = array_distinct($edr_event.target.process.file.sha256)\n    $target_process_file_full_path = array_distinct($edr_event.target.process.file.full_path)\n    $target_process_product_specfic_process_id = array_distinct($edr_event.target.process.product_specific_process_id)\n    $target_process_parent_process_product_specfic_process_id = array_distinct($edr_event.target.process.parent_process.product_specific_process_id)\n    // Commented out principal.user.userid because it is already represented in graph as match variable. If match changes, can uncomment to add to results\n    //$principal_user_userid = array_distinct($edr_event.principal.user.userid)\n    $target_user_userid = array_distinct($edr_event.target.user.userid)\n    $target_url = array_distinct($proxy_event.target.url)\n\n  condition:\n    $proxy_event and $edr_event //and $user_entity\n}\n",
  "author": "Google Cloud Security",
  "severity": {
    "displayName": "High"
  },
  "metadata": {
    "data_source": "zscaler nss, crowdstrike",
    "mitre_attack_tactic": "Execution",
    "type": "alert",
    "description": "Executable downloaded by Microsoft Excel by user with GCP entity relationship",
    "mitre_attack_url": "https://attack.mitre.org/techniques/T1204/002/",
    "mitre_attack_version": "v13.1",
    "assumption": "This rule assumes that GCP DLP has been deployed and resources have been assigned to a user context",
    "priority": "High",
    "mitre_attack_technique": "User Execution: Malicious File",
    "platform": "Windows",
    "tags": "user entity, resource entity"
  },
  "createTime": "2024-10-17T21:28:59.849983Z",
  "revisionCreateTime": "2025-03-17T23:03:38.068943Z",
  "compilationState": "SUCCEEDED",
  "type": "MULTI_EVENT",
  "allowedRunFrequencies": [
    "LIVE",
    "HOURLY",
    "DAILY"
  ],
  "etag": "CMrU4r4GEJj57yA=",
  "inputsUsed": {
    "usesUdm": true
  }
}